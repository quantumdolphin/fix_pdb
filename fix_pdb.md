# FIX-PDB.md

## Overview

This script collection processes and cleans PDB files, particularly those generated by ChimeraX or other modeling tools. It is designed to:

* Parse PDB files into dataframes for further analysis
* Detect multiple models in multi-frame PDBs
* Remove redundant or problematic `MODEL`, `ENDMDL`, and `CONECT` lines
* Fix ligand residue names and numbers
* Convert RNA `HETATM` entries into standard `ATOM` entries

All scripts are written in **debug mode** with liberal comments to help readers understand the logic.

---

## Dependencies

```python
import pandas as pd
```

---

## 1. PDB Parser

```python
def parse_pdb(pdb_file_path):
    """
    Parses a PDB file and returns a pandas DataFrame containing atom-level information.
    Only 'ATOM' and 'HETATM' records are considered.
    """
    records = []

    with open(pdb_file_path, 'r') as f:
        for line_num, line in enumerate(f, 1):
            if line.startswith(("ATOM", "HETATM")):
                try:
                    record_dict = {
                        'record_type' : line[0:6].strip(),
                        'atom_serial' : int(line[6:11].strip()),
                        'atom_name'   : line[12:16].strip(),
                        'alt_loc'     : line[16].strip(),
                        'res_name'    : line[17:20].strip(),
                        'chain_id'    : line[21].strip(),
                        'res_seq'     : int(line[22:26].strip()) if line[22:26].strip().isdigit() else None,
                        'i_code'      : line[26].strip(),
                        'x'           : float(line[30:38].strip()),
                        'y'           : float(line[38:46].strip()),
                        'z'           : float(line[46:54].strip()),
                        'occupancy'   : float(line[54:60].strip()),
                        'temp_factor' : float(line[60:66].strip()),
                        'element'     : line[76:78].strip() if len(line) > 76 else ''
                    }
                    records.append(record_dict)
                except Exception as e:
                    print(f"Line {line_num}: Skipping due to error: {e}")

    return pd.DataFrame(records)
```

---

## 2. Check for MODEL and ENDMDL Records

```python
def check_models_in_pdb(file_path):
    """
    Prints lines where MODEL/ENDMDL tags occur in a PDB file.
    Helpful for identifying multi-model PDBs.
    """
    with open(file_path, 'r') as f:
        for line_number, line in enumerate(f, 1):
            if line.startswith("MODEL") or line.startswith("ENDMDL"):
                print(f"Line {line_number}: {line.strip()}")
```

---

## 3. Fix PDB: Remove MODEL/ENDMDL Only

```python
def fix_pdb_to_single_model(input_pdb, output_pdb):
    """
    Removes MODEL and ENDMDL lines and appends a final END line if missing.
    This ensures the file is interpretable as a single model.
    """
    lines_to_write = []

    with open(input_pdb, 'r') as f:
        for line in f:
            if not line.startswith(("MODEL", "ENDMDL")):
                lines_to_write.append(line.rstrip('\n'))

    if not lines_to_write[-1].startswith("END"):
        lines_to_write.append("END")

    with open(output_pdb, 'w') as out:
        for l in lines_to_write:
            out.write(l + "\n")
```

---

## 4. Fix PDB: Also Remove CONECT Records

```python
def fix_pdb_remove_model_and_conect(input_pdb, output_pdb):
    """
    Removes MODEL, ENDMDL, and CONECT lines from a PDB file.
    Leaves a clean single-model structure.
    """
    lines_to_write = []

    with open(input_pdb, 'r') as f:
        for line in f:
            if not line.startswith(("MODEL", "ENDMDL", "CONECT")):
                lines_to_write.append(line.rstrip('\n'))

    if not lines_to_write[-1].startswith("END"):
        lines_to_write.append("END")

    with open(output_pdb, 'w') as out:
        for line in lines_to_write:
            out.write(line + "\n")
```

---

## 5. Convert RNA HETATM → ATOM

```python
def convert_hetatm_to_atom_for_rna(input_pdb, output_pdb, allowed_rna_res=["A", "C", "G", "U"]):
    """
    Converts HETATM lines to ATOM lines for canonical RNA residues.
    Useful when modeling tools treat RNA nucleotides as hetero-atoms.
    """
    with open(input_pdb, 'r') as fin, open(output_pdb, 'w') as fout:
        for line in fin:
            if line.startswith("HETATM"):
                res_name = line[17:20].strip()
                if res_name in allowed_rna_res:
                    line = "ATOM  " + line[6:]  # keep fixed-width format
            fout.write(line)
```

---

## 6. Fix Ligand Records: `*` → `LIG`, `0` → `999`

```python
def fix_ligand_records(pdb_in, pdb_out):
    """
    Replaces placeholder ligand residue names and numbers in HETATM records:
    - `*` becomes `LIG`
    - `0` becomes `999`
    """
    with open(pdb_in, 'r') as fin, open(pdb_out, 'w') as fout:
        for line in fin:
            if line.startswith("HETATM"):
                res_name = line[17:20].strip()
                res_seq = line[22:26].strip()

                if res_name == "*":
                    line = line[:17] + f"{'LIG':>3}" + line[20:]

                if res_seq == "0":
                    line = line[:22] + f"{999:>4}" + line[26:]

            fout.write(line)
```

---

## Example Workflow

```python
# Step-by-step pipeline for cleaning up a problematic PDB file

# 1. Remove MODEL, ENDMDL, and CONECT lines
fix_pdb_remove_model_and_conect("01-apr-AR-model.pdb", "01-apr-cleaned-v1.pdb")

# 2. Convert RNA HETATM entries to ATOM entries
convert_hetatm_to_atom_for_rna("01-apr-cleaned-v1.pdb", "01-apr-cleaned-v2.pdb")

# 3. Fix ligand formatting (e.g. '*' → 'LIG', '0' → '999')
fix_ligand_records("01-apr-cleaned-v2.pdb", "01-apr-cleaned-v3.pdb")
```

---

## Troubleshooting Notes

### Parsing Errors

If you see errors like:

```
ValueError: invalid literal for int() with base 10: 'A0000'
```

Check whether the PDB file is malformed or contains unexpected atom serial formats. Use debug printing to isolate problematic lines.

### Windows Compatibility

```python
# grep is a Unix command and will not work on Windows CMD or PowerShell
# Instead, use Python string filtering or search within an IDE:

with open("01-apr-AR-model.pdb") as f:
    for line in f:
        if line.startswith("ATOM"):
            print(line.strip())
```

---

## Output Example

```python
# After full cleanup, parse the final cleaned PDB
final_df = parse_pdb("01-apr-cleaned-v3.pdb")
print(final_df.head())
```

---

## License

MIT License

---

## Author

This notebook and scripts were debugged and annotated for sharing on GitHub by request.
